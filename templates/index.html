<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Building Permits Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Include jQuery or other JavaScript library for datepicker -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Add OverlappingMarkerSpiderfier & MarkerCluster plugins -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-overlapping-marker-spiderfier@1.0.6/dist/oms.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css" />

    <style>
        #mapid { height: 600px; }
    </style>
</head>
<body>

<div>
    <label for="datepicker">Select a Date:</label>
    <input type="text" id="datepicker">
</div>
<div id="mapid"></div>

<script>
$(function() {
    var map = L.map('mapid').setView([51.0486, -114.0708], 13); // Calgary coordinates
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var markerCluster = L.markerClusterGroup().addTo(map);
    var oms = new OverlappingMarkerSpiderfier(map);

    $('#datepicker').datepicker({
        onSelect: function(dateText) {
            var dateParts = dateText.split('-');
            var startDate = new Date(dateParts[2], parseInt(dateParts[1])-1, dateParts[0]);
            var endDate = new Date(startDate.getTime()); // For simplicity, assuming same start and end date here

            $.ajax({
                url: '/search',
                type: 'POST',
                data: { start_date: startDate.toISOString(), end_date: endDate.toISOString() },
                success: function(response) {
                    processMarkers(response);
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                }
            });
        }
    });

    function processMarkers(markersData) {
        markerCluster.clearLayers();

        markersData.forEach(function(permit) {
            var marker = L.marker([permit.latitude, permit.longitude]).bindPopup(generatePopupContent(permit));
            oms.addMarker(marker);
            markerCluster.addLayer(marker);
        });
    }

    function generatePopupContent(permit) {
        return `
            <b>Issued Date:</b> ${permit.issueddate}<br/>
            <b>Work Class Group:</b> ${permit.workclassgroup}<br/>
            <b>Contractor Name:</b> ${permit.contractorname}<br/>
            <b>Community Name:</b> ${permit.communityname}<br/>
            <b>Original Address:</b> ${permit.originaladdress}
        `;
    }
});
</script>

</body>
</html>